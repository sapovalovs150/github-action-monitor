#!/bin/bash
# backup-watchdog.sh - –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç –ø–∞–ø–∫—É –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã/–ø–∞–ø–∫–∏

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
LOG_FILE="backup-watchdog.log"
CONFIG_FILE="backup-watchdog.conf"
CHECK_INTERVAL=5

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log_message() {
    local level="$1"
    local message="$2"
    local timestamp=$(date +"%Y-%m-%d %H:%M:%S")
    echo "[$timestamp] [$level] $message" | tee -a "$LOG_FILE"
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ–¥–∞–Ω –ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç (–ø—É—Ç—å –∫ –ø–∞–ø–∫–µ)
if [ $# -eq 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–∫–∞–∑–∞–Ω–∞ –ø–∞–ø–∫–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è."
    echo "   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./backup-watchdog.sh /–ø—É—Ç—å/–∫/–ø–∞–ø–∫–µ"
    exit 1
fi

WATCH_DIR="$1"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∫–∞–∑–∞–Ω–Ω–∞—è –ø–∞–ø–∫–∞
if [ ! -d "$WATCH_DIR" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ü–∞–ø–∫–∞ '$WATCH_DIR' –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
    exit 1
fi

log_message "INFO" "–ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–∞–ø–∫–∏: $WATCH_DIR"
echo "üì¶ –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–∞–∫–æ–≤–∞–Ω—ã –≤ .tar.gz –∏ —É–¥–∞–ª–µ–Ω—ã"
echo "üõë –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
echo "---"

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
while true; do
    # –ò—â–µ–º —Ñ–∞–π–ª—ã –∏ –ø–∞–ø–∫–∏ –≤ —Ü–µ–ª–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    find "$WATCH_DIR" -maxdepth 1 -mindepth 1 ! -name "*.tar.gz" | while read -r ITEM_PATH; do
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –∞—Ä—Ö–∏–≤–∞ —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π
        ITEM_NAME=$(basename "$ITEM_PATH")
        TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
        ARCHIVE_NAME="backup_${TIMESTAMP}_${ITEM_NAME}.tar.gz"
        ARCHIVE_PATH="$WATCH_DIR/$ARCHIVE_NAME"
        
        # –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º —Ñ–∞–π–ª –∏–ª–∏ –ø–∞–ø–∫—É
        echo "[$(date +'%H:%M:%S')] üì¶ –ê—Ä—Ö–∏–≤–∏—Ä—É—é: $ITEM_NAME"
        
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
        PARENT_DIR=$(dirname "$ITEM_PATH")
        BASENAME=$(basename "$ITEM_PATH")
        
        if tar -czf "$ARCHIVE_PATH" -C "$PARENT_DIR" "$BASENAME" 2>/dev/null; then
            echo "   ‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∞—Ä—Ö–∏–≤: $ARCHIVE_NAME"
            
            # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª/–ø–∞–ø–∫—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
            rm -rf "$ITEM_PATH"
            echo "   üóëÔ∏è  –£–¥–∞–ª—ë–Ω –∏—Å—Ö–æ–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç: $ITEM_NAME"
        else
            echo "   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—Ä—Ö–∏–≤–∞ –¥–ª—è: $ITEM_NAME"
        fi
        
        echo "---"
    done
    
    # –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
    sleep 5
done
