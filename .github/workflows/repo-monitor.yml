name: Repository Size Monitor

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  # –ó–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub
  workflow_dispatch:
    inputs:
      target_folder:
        description: '–ü—É—Ç—å –∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º–æ–π –ø–∞–ø–∫–µ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è)'
        required: true
        default: 'src'
        type: string

# –õ–∏–º–∏—Ç—ã (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –ø–æ–¥ —Å–≤–æ–∏ –Ω—É–∂–¥—ã)
env:
  FOLDER_SIZE_LIMIT_MB: 50      # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–∞–ø–∫–∏ –≤ –ú–ë
  FILE_COUNT_LIMIT: 100         # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤
  FOLDER_COUNT_LIMIT: 20        # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞–ø–æ–∫

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set target folder
      id: set_folder
      run: |
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞–ø–∫—É –∏–∑ –∏–Ω–ø—É—Ç–∞ workflow_dispatch –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—É—é 'src'
        if [ -n "${{ github.event.inputs.target_folder }}" ]; then
          echo "TARGET_FOLDER=${{ github.event.inputs.target_folder }}" >> $GITHUB_ENV
        else
          echo "TARGET_FOLDER=src" >> $GITHUB_ENV
        fi
        echo "–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º–∞—è –ø–∞–ø–∫–∞: ${{ env.TARGET_FOLDER }}"

    - name: Check if target folder exists
      id: check_folder
      run: |
        if [ ! -d "${{ env.TARGET_FOLDER }}" ]; then
          echo "‚ùå –ü–∞–ø–∫–∞ '${{ env.TARGET_FOLDER }}' –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏"
          echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–∞–ø–∫–∏ –≤ –∫–æ—Ä–Ω–µ:"
          find . -maxdepth 1 -type d | sort
          exit 1
        fi

    - name: Calculate folder statistics
      id: stats
      run: |
        echo "=== üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø ==="
        
        # –†–∞–∑–º–µ—Ä —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–∞–ø–∫–∏ –≤ –ú–ë
        if [ -d "${{ env.TARGET_FOLDER }}" ]; then
          FOLDER_SIZE_MB=$(du -sm "${{ env.TARGET_FOLDER }}" | cut -f1)
          echo "–†–∞–∑–º–µ—Ä –ø–∞–ø–∫–∏ '${{ env.TARGET_FOLDER }}': ${FOLDER_SIZE_MB} MB"
          echo "FOLDER_SIZE_MB=${FOLDER_SIZE_MB}" >> $GITHUB_ENV
        else
          echo "FOLDER_SIZE_MB=0" >> $GITHUB_ENV
        fi
        
        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ
        FILE_COUNT=$(find "${{ env.TARGET_FOLDER }}" -type f 2>/dev/null | wc -l || echo "0")
        echo "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –≤ '${{ env.TARGET_FOLDER }}': ${FILE_COUNT}"
        echo "FILE_COUNT=${FILE_COUNT}" >> $GITHUB_ENV
        
        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞–ø–æ–∫ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ
        FOLDER_COUNT=$(find "${{ env.TARGET_FOLDER }}" -type d 2>/dev/null | tail -n +2 | wc -l || echo "0")
        echo "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞–ø–æ–∫ –≤ '${{ env.TARGET_FOLDER }}': ${FOLDER_COUNT}"
        echo "FOLDER_COUNT=${FOLDER_COUNT}" >> $GITHUB_ENV
        
        echo "=== ‚ö†Ô∏è  –£–°–¢–ê–ù–û–í–õ–ï–ù–ù–´–ï –õ–ò–ú–ò–¢–´ ==="
        echo "–ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä –ø–∞–ø–∫–∏: ${{ env.FOLDER_SIZE_LIMIT_MB }} MB"
        echo "–ú–∞–∫—Å. —Ñ–∞–π–ª–æ–≤: ${{ env.FILE_COUNT_LIMIT }}"
        echo "–ú–∞–∫—Å. –ø–∞–ø–æ–∫: ${{ env.FOLDER_COUNT_LIMIT }}"

    - name: Validate against limits
      id: validate
      run: |
        echo "=== ‚úÖ –ü–†–û–í–ï–†–ö–ê –õ–ò–ú–ò–¢–û–í ==="
        FAILED=0
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–ø–∫–∏
        if [ "${{ env.FOLDER_SIZE_MB }}" -gt "${{ env.FOLDER_SIZE_LIMIT_MB }}" ]; then
          echo "‚ùå –ü–†–ï–í–´–®–ï–ù –õ–ò–ú–ò–¢ –†–ê–ó–ú–ï–†–ê: ${{ env.FOLDER_SIZE_MB }} MB > ${{ env.FOLDER_SIZE_LIMIT_MB }} MB"
          FAILED=1
        else
          echo "‚úÖ –†–∞–∑–º–µ—Ä –ø–∞–ø–∫–∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö: ${{ env.FOLDER_SIZE_MB }} MB ‚â§ ${{ env.FOLDER_SIZE_LIMIT_MB }} MB"
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–∞–π–ª–æ–≤
        if [ "${{ env.FILE_COUNT }}" -gt "${{ env.FILE_COUNT_LIMIT }}" ]; then
          echo "‚ùå –ü–†–ï–í–´–®–ï–ù –õ–ò–ú–ò–¢ –§–ê–ô–õ–û–í: ${{ env.FILE_COUNT }} > ${{ env.FILE_COUNT_LIMIT }}"
          FAILED=1
        else
          echo "‚úÖ –§–∞–π–ª–æ–≤ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö: ${{ env.FILE_COUNT }} ‚â§ ${{ env.FILE_COUNT_LIMIT }}"
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–∞–ø–æ–∫
        if [ "${{ env.FOLDER_COUNT }}" -gt "${{ env.FOLDER_COUNT_LIMIT }}" ]; then
          echo "‚ùå –ü–†–ï–í–´–®–ï–ù –õ–ò–ú–ò–¢ –ü–ê–ü–û–ö: ${{ env.FOLDER_COUNT }} > ${{ env.FOLDER_COUNT_LIMIT }}"
          FAILED=1
        else
          echo "‚úÖ –ü–∞–ø–æ–∫ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö: ${{ env.FOLDER_COUNT }} ‚â§ ${{ env.FOLDER_COUNT_LIMIT }}"
        fi
        
        # –ò—Ç–æ–≥
        echo ""
        echo "=== üìà –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ==="
        echo "–ü–∞–ø–∫–∞: ${{ env.TARGET_FOLDER }}"
        echo "–†–∞–∑–º–µ—Ä: ${{ env.FOLDER_SIZE_MB }} MB (–ª–∏–º–∏—Ç: ${{ env.FOLDER_SIZE_LIMIT_MB }} MB)"
        echo "–§–∞–π–ª–æ–≤: ${{ env.FILE_COUNT }} (–ª–∏–º–∏—Ç: ${{ env.FILE_COUNT_LIMIT }})"
        echo "–ü–∞–ø–æ–∫: ${{ env.FOLDER_COUNT }} (–ª–∏–º–∏—Ç: ${{ env.FOLDER_COUNT_LIMIT }})"
        
        if [ "$FAILED" -eq 1 ]; then
          echo "::error::–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ."
          exit 1
        else
          echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
        fi